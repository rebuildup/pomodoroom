name: PR Guardrails

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

jobs:
  guardrails:
    runs-on: ubuntu-latest
    steps:
      - name: Validate issue link and branch conventions
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || "";
            const title = pr.title || "";
            const combined = `${title}\n${body}`;

            const issueLinkPattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#\d+/i;
            const branchPattern = /^issue-\d+(-[a-z0-9-]+)?$/;

            const errors = [];
            const warnings = [];

            if (!issueLinkPattern.test(combined)) {
              errors.push("PR must include a closing keyword like `Closes #123`.");
            }

            if (!branchPattern.test(pr.head.ref)) {
              warnings.push(`Branch '${pr.head.ref}' does not follow issue-* convention.`);
            }

            if (!/##\s*Test Evidence/i.test(body)) {
              warnings.push("PR template section 'Test Evidence' is missing.");
            }

            for (const warning of warnings) {
              core.warning(warning);
            }

            if (errors.length > 0) {
              core.setFailed(errors.join("\n"));
            }