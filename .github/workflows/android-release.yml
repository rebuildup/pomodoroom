name: Android Release (prebuild + Gradle)

on:
  workflow_dispatch: {}
  push:
    branches:
      - main

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install Android SDK command-line tools and packages
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
          # Ensure ANDROID_SDK_ROOT is expanded to the runner's home directory
          export ANDROID_SDK_ROOT="$HOME/Android/Sdk"
          mkdir -p "$ANDROID_SDK_ROOT"
          cd "$ANDROID_SDK_ROOT"
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          mkdir -p tmp_cmdline
          unzip -q cmdline-tools.zip -d tmp_cmdline
          # Normalize extracted structure into $ANDROID_SDK_ROOT/cmdline-tools/latest
          mkdir -p cmdline-tools/latest
          if [ -d "tmp_cmdline/cmdline-tools" ]; then
            # zip contained 'cmdline-tools' dir
            mv tmp_cmdline/cmdline-tools/* cmdline-tools/latest/ || true
          else
            # move any extracted content into latest
            for d in tmp_cmdline/*; do
              if [ -d "$d" ]; then
                mv "$d"/* cmdline-tools/latest/ || true
              fi
            done
          fi
          # ensure executables have exec bit
          chmod -R +x cmdline-tools/latest/bin || true
          export PATH="$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin"
          echo "PATH=$PATH"
          echo "Listing $ANDROID_SDK_ROOT contents and cmdline-tools structure"
          ls -la "$ANDROID_SDK_ROOT" || true
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools" || true
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest" || true
          ls -la "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" || true
          if ! command -v sdkmanager >/dev/null 2>&1; then
            echo "sdkmanager: command not found"
            echo "Dumping $ANDROID_SDK_ROOT file tree for debug"
            find "$ANDROID_SDK_ROOT" -maxdepth 3 -type f -ls || true
            exit 1
          fi
          yes | sdkmanager --licenses
          sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2"
          ls -la "$ANDROID_SDK_ROOT"

      - name: Install app dependencies
        run: |
          cd mobile
          npm ci

      - name: Prebuild Android native project
        run: |
          cd mobile
          npx expo prebuild --platform android --no-install

      - name: Build unsigned release APK
        run: |
          cd mobile/android
          chmod +x gradlew
          ./gradlew assembleRelease
          ls -l app/build/outputs/apk/release || true

      - name: Write keystore from secret
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ]; then echo "Missing ANDROID_KEYSTORE_BASE64"; exit 1; fi
          echo "$KEYSTORE_BASE64" | base64 --decode > mobile/android/keystore.jks
          ls -l mobile/android/keystore.jks

      - name: Sign and align APK
        env:
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        run: |
          cd mobile/android
          # expo prebuild generates app-release.apk (debug-signed); re-sign with release key
          APK_UNSIGNED=app/build/outputs/apk/release/app-release.apk
          if [ ! -f "$APK_UNSIGNED" ]; then echo "APK not found at $APK_UNSIGNED"; ls -l app/build/outputs/apk/release/ || true; exit 1; fi
          HOME_SDK="$HOME/Android/Sdk"
          "$HOME_SDK"/build-tools/33.0.2/apksigner sign --ks keystore.jks --ks-key-alias "$ANDROID_KEY_ALIAS" --ks-pass pass:$ANDROID_KEYSTORE_PASSWORD --key-pass pass:$ANDROID_KEY_PASSWORD --out app-release-signed.apk "$APK_UNSIGNED"
          "$HOME_SDK"/build-tools/33.0.2/zipalign -v -p 4 app-release-signed.apk app-release-signed-aligned.apk
          mv app-release-signed-aligned.apk $GITHUB_WORKSPACE/pomodoroom-mobile-release.apk
          ls -l $GITHUB_WORKSPACE/pomodoroom-mobile-release.apk

      - name: Upload signed APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: pomodoroom-mobile-release.apk
          path: pomodoroom-mobile-release.apk
