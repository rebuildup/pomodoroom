# UI/Dialog Agent 仕様書

> **上位規範:** [CORE_POLICY.md](file:///c:/Users/rebui/Desktop/pomodoroom/CORE_POLICY.md)
> **役割定義:** [AGENTS.md](file:///c:/Users/rebui/Desktop/pomodoroom/AGENTS.md) §1.3
> **技術詳細:** [CLAUDE.md](file:///c:/Users/rebui/Desktop/pomodoroom/CLAUDE.md)

---

## 1. 責務の境界

### やること

- 回避不能な介入ダイアログ（Tauriウインドウ）の実装
- タスク操作UI（全状態遷移のトリガーボタン）
- Material 3 デザイン基準に準拠したフロントエンド
- Pressureモードに応じた介入強度の視覚的表現
- コンテキスト（数理モデルベース）の再提示
- コンフリクト解決ダイアログ（Google Calendar同期時）
- ウインドウ管理（Normal / Pinned / Float モード）

### やらないこと

- スケジュール計算・Pressure算出（→ Scheduler Agent）
- Google Calendar API通信（→ Integrator Agent）
- タスクの優先度計算（→ Scheduler Agent）
- ビジネスロジック全般（→ Rustコア）

---

## 2. 介入ダイアログ — 核心機能

### 2.1 設計原則（CORE_POLICY §6 より）

CORE_POLICY の二大哲学「集中の引力」を物理的に実現するのが、本ダイアログの役割である。

- **回避不能**: 最前面に表示。最小化・背面移動・無視が不可能
- **操作必須**: ユーザーが明示的アクションを行うまで消えない
- **文脈提示**: 「なぜこの通知か」「次に何をすべきか」を常に明示
- **Tauri独自ウインドウ**: OS標準通知は使わない

### 2.2 ダイアログの種別

| 種別 | トリガー | 表示内容 | ユーザーアクション |
|------|----------|----------|-------------------|
| **タイマー完了** | フォーカスタイマーの終了 | 完了タスクのサマリー + 次タスク候補 | 「次を開始」「休憩」「延長」 |
| **Active空白** | Activeタスクなし + 一定時間経過 | Floating候補 or Active候補 | 「開始」「先送り」 |
| **Pressure変更** | モード遷移（Normal→Pressure等） | 現在のPressure + 推奨アクション | 「了解」+ 推奨アクションボタン |
| **Wait解除** | 待機条件の解消 | 再開可能タスク + 数理コンテキスト | 「再開」「後回し」 |
| **休憩終了** | 休憩タイマーの終了 | 次のActive候補 + コンテキスト | 「開始」 |
| **コンフリクト** | Calendar同期でデータ衝突 | ローカル版 vs リモート版の比較 | 「ローカル」「リモート」 |

### 2.3 Tauriウインドウ実装仕様

```typescript
// 介入ダイアログウインドウの生成
invoke('cmd_open_window', {
  label: 'intervention-dialog',
  title: '',                    // タイトルバーなし
  width: 480,
  height: 320,
  decorations: false,          // フレームレス
  alwaysOnTop: true,           // 最前面固定
  center: true,                // 画面中央
  resizable: false,
  skipTaskbar: true,
  focus: true,                 // フォーカス強奪
  closable: false,             // ✕ボタンなし
});
```

**重要:** `closable: false` + `alwaysOnTop: true` の組み合わせにより、
ユーザーは操作ボタンを押す以外にダイアログを消す方法がない。

### 2.4 介入強度のグラデーション

Pressureモードに応じてダイアログの視覚的な強さを変える:

| モード | 背景色 | アニメーション | サウンド |
|--------|--------|---------------|---------|
| Normal | `--md-sys-color-surface` | なし | ソフトチャイム |
| Pressure | `--md-sys-color-error-container` | パルスアニメーション | アテンションベル |
| Overload | `--md-sys-color-error` | 強いパルス + シェイク | 警告音 |

---

## 3. タスク操作UI

### 3.1 状態遷移ボタンマッピング

| 現在の状態 | 表示するボタン |
|-----------|---------------|
| `ready` | ▶ 開始, ↓ 先送り |
| `running` | ✓ 完了, ⏸ 中断, ↻ 延長 |
| `paused` | ▶ 再開, ↓ 先送り |
| `done` | （操作なし） |

### 3.2 各操作のUIフロー

**開始（READY → RUNNING）:**
1. ボタン押下
2. 既存のActive タスクがあれば自動的にPAUSED
3. 選択したタスクがRUNNINGに遷移
4. タイマー開始
5. ダイアログ閉じる

**完了（RUNNING → DONE）:**
1. ボタン押下
2. タスクDONE
3. タイマー停止
4. Scheduler に次タスク候補を要求
5. 次タスク提案ダイアログを表示

**延長（RUNNING → RUNNING, タイマーリセット）:**
1. ボタン押下
2. 延長時間の選択UI表示（柔軟サジェスト + スライダー）
3. タイマーを選択した時間でリセット
4. Active維持、ダイアログ閉じる

**中断（RUNNING → PAUSED）:**
1. ボタン押下
2. タスクPAUSED（**テキスト入力なし・ワンクリックで完結**）
3. タイマー停止
4. システムが操作履歴・メタデータを自動記録
5. Scheduler に次タスク候補を要求

**再開（PAUSED → RUNNING）:**
1. ボタン押下
2. コンテキスト再提示（数理モデルから自動導出された文脈情報）
3. タスクRUNNING
4. タイマー開始
5. ダイアログ閉じる

---

## 4. コンテキスト再提示UI（数理モデルベース）

### 4.1 再開時の表示

タスク再開ダイアログには、数理モデルから自動導出された文脈情報を表示する:

```
┌─────────────────────────────────────┐
│  📋 タスク再開                        │
│                                      │
│  タスク名: APIエンドポイントの実装      │
│  中断から: 2時間15分                   │
│  中断理由: 休憩時間到達                │
│                                      │
│  📊 コンテキスト:                       │
│  ・経過 45分/見積90分 (進捍50%)        │
│  ・中断2回・延長1回                    │
│  ・同プロジェクトの残タスク: 3件          │
│                                      │
│  残り見積もり: 約45分                  │
│                                      │
│  [▶ 再開する]    [↓ 後回し]            │
└─────────────────────────────────────┘
```

**ポイント:** ユーザーにテキスト入力を求めない。すべての情報は
タスクのメタデータ・操作履歴・タグ関係性から自動で導出される。

---

## 5. コンフリクト解決ダイアログ

Google Calendar 同期でコンフリクトが発生した場合の表示:

```
┌──────────────────────────────────────────┐
│  ⚠️ データの競合                           │
│                                           │
│  タスク「レポート作成」に変更の競合があります │
│                                           │
│  ローカル版:                               │
│    状態: Running → Done                    │
│    更新: 14:30                             │
│                                           │
│  リモート版 (Google Calendar):              │
│    状態: Running (変更なし)                  │
│    更新: 14:25                             │
│                                           │
│  [ローカルを採用]    [リモートを採用]         │
└──────────────────────────────────────────┘
```

**設計原則:** ユーザー負荷を最小限に。技術的詳細は表示せず、
「どちらが正しいか」の二択のみ提示する。

---

## 6. Material 3 デザイン基準

### 6.1 コンポーネント配置

```
src/components/m3/     ← 全ての新UIコンポーネント
src/views/             ← ページレベルのビュー
```

### 6.2 カラートークン

CSS Custom Properties (`--md-sys-color-*`) を使用。`index.css` に定義済み。

### 6.3 スタイルルール

- Material 3 カラートークン準拠
- **文字色への色使用を極力排除**（白/黒/グレー系のみ）
- グラデーション、影、ホバーアニメーションを制限
- 動きは状態遷移に紐づく**明示的な意味を持つもののみ**
- Tailwind CSS v4 + CSS Custom Properties

### 6.4 アイコン

Material Symbols を使用。lucide-react は**禁止**（移行対象）。

---

## 7. ウインドウモード

| モード | 装飾 | 常時最前面 | サイズ | 用途 |
|--------|------|-----------|--------|------|
| Normal | あり | なし | 800×600 | メインUI |
| Pinned | あり | あり | 800×600 | 常時表示 |
| Float | なし | あり | 280×280 | ミニタイマー |
| Intervention | なし | あり | 480×320 | 介入ダイアログ |

---

## 8. 関連ファイル一覧

| ファイル | 役割 |
|----------|------|
| `src/views/ShellView.tsx` | アプリ全体のオーケストレーター |
| `src/components/m3/NowHub.tsx` | タイマー + Active表示 |
| `src/components/m3/TaskBoard.tsx` | タスクボード |
| `src/components/m3/TaskCard.tsx` | タスクカード |
| `src/components/m3/TimerControls.tsx` | タイマー操作ボタン |
| `src/components/m3/NextTaskCandidates.tsx` | 次タスク提案 |
| `src/hooks/useTaskState.ts` | タスク状態管理 |
| `src/hooks/useTauriTimer.ts` | タイマーフック |
| `src/types/task-state.ts` | 状態遷移定義 |
| `src/types/pressure.ts` | Pressure型定義 |
| `src-tauri/src/window.rs` | ウインドウ管理 |
| `src-tauri/src/tray.rs` | システムトレイ |
| `src/index.css` | M3デザイントークン定義 |

---

## 9. 禁止事項（UI固有）

1. **「Delay」「遅延」の表示** → 「Pressure」を使え
2. **OS標準通知の使用** → 独自ダイアログウインドウのみ
3. **ダイアログに閉じるボタンを付ける** → 操作ボタンのみ
4. **選択肢を3つ以上並べる** → 主アクションは最大2〜3
5. **lucide-react アイコンの使用** → Material Symbols のみ
6. **モックデータでUIを埋める** → 実データに接続するか、空状態を表示
7. **中断時にテキスト入力を要求する** → ワンクリックで完結、コンテキストは自動記録
